# 📊 엑셀 파일을 열어놓은 상태에서 로깅하기

## 🎯 개요

관리자가 `logs/unanswered_questions.xlsx` 파일을 **열어놓은 상태**에서도 챗봇이 새로운 질문을 추가할 수 있습니다!

---

## 🔄 작동 방식

### 시나리오 1: 엑셀 파일이 닫혀있을 때 (정상)

```
사용자 질문 (답변 못 찾음)
    ↓
바로 엑셀 파일에 저장 ✅
    ↓
logs/unanswered_questions.xlsx 업데이트
```

**결과**: 즉시 저장됨!

---

### 시나리오 2: 엑셀 파일이 열려있을 때 (자동 처리)

```
관리자: logs/unanswered_questions.xlsx 열어놓음 📂
    ↓
사용자 질문 (답변 못 찾음)
    ↓
엑셀 저장 시도 → 실패 (파일 잠김)
    ↓
1초 후 재시도 (최대 5번)
    ↓
여전히 실패
    ↓
임시 파일에 저장 ✅
logs/unanswered_questions_temp.txt
    ↓
관리자: 엑셀 파일 닫음
    ↓
자동으로 임시 파일 내용 병합! ✅
    ↓
logs/unanswered_questions.xlsx 업데이트
```

**결과**: 엑셀을 닫으면 자동으로 반영됨!

---

## 💡 사용 방법

### 관리자 워크플로우

#### 1단계: 엑셀 열기
```
logs/unanswered_questions.xlsx 파일 열기
→ 미답변 질문 확인하면서 작업
```

#### 2단계: 실시간 모니터링
```
엑셀을 열어놓은 상태에서:
- 사용자들이 질문 계속 입력
- 답변 못 찾은 질문들이 임시 파일에 저장됨
- logs/unanswered_questions_temp.txt에 누적
```

#### 3단계: 엑셀 닫기
```
작업 완료 후 엑셀 파일 닫기
→ 자동으로 임시 파일 내용이 엑셀에 병합됨!
```

#### 4단계: 확인
```
로그 페이지 새로고침
http://localhost:5000/logs
→ 새로운 질문들이 추가되어 있음!
```

---

## 🛠️ 기술 상세

### 재시도 메커니즘
```python
max_retries = 5  # 최대 5번 시도
wait_time = 1초  # 각 시도 사이 1초 대기

시도 1: 엑셀 저장 시도 → 실패 → 1초 대기
시도 2: 엑셀 저장 시도 → 실패 → 1초 대기
시도 3: 엑셀 저장 시도 → 실패 → 1초 대기
시도 4: 엑셀 저장 시도 → 실패 → 1초 대기
시도 5: 엑셀 저장 시도 → 실패 → 임시 파일에 저장
```

### 임시 파일 형식
```
파일명: logs/unanswered_questions_temp.txt
형식: 타임스탬프|질문

예시:
2025-09-30 14:30:15|회의실 예약 방법은?
2025-09-30 14:35:22|휴가 신청은 어떻게?
2025-09-30 14:40:18|주차장 위치 알려줘
```

### 자동 병합
```python
# /api/unanswered 호출 시마다 병합 시도
def get_unanswered():
    chatbot.question_logger.merge_temp_file()  # 자동 병합
    # ...
```

**언제 병합?**
- 로그 페이지 접속 시
- 로그 페이지 자동 새로고침 시 (5초마다)
- 새로고침 버튼 클릭 시

---

## 📋 로그 예시

### 터미널 로그

#### 엑셀 닫혀있을 때:
```
INFO:question_logger:질문 로그 추가 성공: 회의실 예약 방법은?
```

#### 엑셀 열려있을 때:
```
WARNING:question_logger:엑셀 파일이 열려있습니다. 1초 후 재시도... (1/5)
WARNING:question_logger:엑셀 파일이 열려있습니다. 2초 후 재시도... (2/5)
...
WARNING:question_logger:엑셀 파일에 저장 실패. 임시 파일에 저장합니다
INFO:question_logger:임시 파일에 저장 완료: 회의실 예약 방법은?
💡 팁: 엑셀 파일을 닫으면 임시 파일 내용이 자동으로 병합됩니다.
```

#### 엑셀 닫은 후:
```
INFO:question_logger:임시 파일 병합 완료: 3개 질문
```

---

## ✅ 장점

### 1. 유연성
```
✅ 엑셀을 열어놓고 작업 가능
✅ 동시에 로깅도 계속 진행
✅ 작업 방해 없음
```

### 2. 안정성
```
✅ 데이터 손실 없음
✅ 자동 재시도 (5번)
✅ 임시 파일 백업
```

### 3. 자동화
```
✅ 자동 병합
✅ 자동 정리
✅ 수동 작업 불필요
```

---

## 🎯 실제 사용 예시

### 시나리오: 금요일 오후 작업

```
14:00 - 관리자
  → logs/unanswered_questions.xlsx 열기
  → 이번 주 질문들 확인 시작

14:15 - 사용자 A
  → "복지몰 이용 방법은?" 질문
  → 답변 못 찾음
  → 임시 파일에 저장 ✅

14:30 - 사용자 B
  → "출장 신청 절차" 질문
  → 답변 못 찾음
  → 임시 파일에 저장 ✅

14:45 - 사용자 C
  → "재택근무 규정" 질문
  → 답변 못 찾음
  → 임시 파일에 저장 ✅

15:00 - 관리자
  → 작업 완료, 엑셀 닫기
  → 자동으로 3개 질문 병합됨! ✅

15:05 - 관리자
  → 로그 페이지 확인
  → 새로운 3개 질문 확인됨
  → data.xlsx에 답변 추가 준비
```

---

## 🔧 고급 설정

### 재시도 횟수 조정
```python
# question_logger.py
def log_unknown_question(self, question, max_retries=5):
                                            #  ↑
                                         # 10으로 늘리면 더 많이 시도
```

### 재시도 대기 시간 조정
```python
# question_logger.py - 96번째 줄
time.sleep(1)  # 1초 → 0.5초로 줄이면 더 빠르게
```

---

## 📁 파일 구조

```
logs/
├── unanswered_questions.xlsx      ← 메인 로그 파일
└── unanswered_questions_temp.txt  ← 임시 파일 (자동 생성/삭제)
```

**임시 파일은**:
- 엑셀이 열려있을 때만 생성
- 엑셀 닫으면 자동 병합 후 삭제
- 보통 존재하지 않음

---

## 🎉 요약

### 핵심 포인트

1. **엑셀 열어놓아도 OK**
   - 작업하면서 실시간 확인 가능
   - 로깅은 백그라운드에서 계속 진행

2. **자동 재시도**
   - 5번 시도 (총 5초)
   - 실패하면 임시 파일에 저장

3. **자동 병합**
   - 엑셀 닫으면 자동 반영
   - 데이터 손실 없음

4. **투명한 작동**
   - 터미널에서 상태 확인 가능
   - 로그로 모든 과정 추적

---

## 🚀 실전 테스트

### 테스트 방법:

1. **엑셀 열기**
   ```
   logs/unanswered_questions.xlsx 파일 열기
   ```

2. **챗봇 테스트**
   ```bash
   py -3.11 test_logging.py
   ```

3. **터미널 확인**
   ```
   "엑셀 파일이 열려있습니다. 재시도..."
   "임시 파일에 저장 완료"
   ```

4. **엑셀 닫기**
   ```
   파일 저장 → 닫기
   ```

5. **로그 페이지 확인**
   ```
   http://localhost:5000/logs
   → 새로고침하면 임시 파일 내용이 자동 병합됨!
   ```

---

**Made with ❤️ for KTR**

**핵심**: 엑셀을 열어놓고 작업해도 됩니다! 닫으면 자동으로 병합됩니다! 🎯
